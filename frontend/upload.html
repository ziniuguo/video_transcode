<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link href="/assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #uploadProgressContainer {
            width: 100%;
            margin-top: 20px;
            position: relative;
            text-align: center;
        }

        #uploadProgress {
            width: 100%;
            height: 50px;
        }

        #progressLabel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-weight: bold;
        }

        .folder-content {
            margin-left: 20px;
            display: none; /* 初始状态为收起 */
        }

        .folder-header {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>File Upload</h2>
    <form id="uploadForm">
        <div class="mb-3">
            <label for="fileInput" class="form-label">Choose a video file</label>
            <input type="file" id="fileInput" name="video" class="form-control" accept="video/*">
        </div>
        <button type="button" class="btn btn-primary" id="uploadButton">Upload</button>
    </form>

    <!-- 上传和转码进度条 -->
    <div id="uploadProgressContainer">
        <progress id="uploadProgress" value="0" max="100"></progress>
        <div id="progressLabel">Waiting...</div>
    </div>

    <div id="uploadStatus" class="mt-3"></div>
    <div id="fileLinks" class="mt-4"></div>

    <!-- 注销按钮 -->
    <button type="button" class="btn btn-warning mt-3" id="logoutButton">Logout</button>
</div>

<script src="/assets/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let sessionUsername = '';

    // 获取当前会话中的用户名
    function getSessionUsername() {
        fetch('http://13.211.82.62:3000/getUserInfo', {
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                return response.json();
            })
            .then(data => {
                sessionUsername = data.username;
                loadFileList();  // 加载文件列表
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('uploadStatus').innerText = 'An error occurred while fetching user info: ' + error.message;
            });
    }

    // 加载文件列表
    function loadFileList() {
        fetch('http://13.211.82.62:3000/browse/' + encodeURIComponent(sessionUsername), {
            credentials: 'include'
        })
            .then(response => response.json())
            .then(fileList => {
                const fileLinksDiv = document.getElementById('fileLinks');
                fileLinksDiv.innerHTML = ''; // 清空之前的内容

                const addedFolders = new Set(); // 用于追踪已添加的文件夹
                const folderContentMap = {};    // 存储文件夹和文件的映射

                fileList.forEach(file => {
                    const folderName = file.folderName;
                    const filename = file.filename;

                    if (!folderContentMap[folderName]) {
                        folderContentMap[folderName] = []; // 初始化文件夹
                    }
                    folderContentMap[folderName].push({
                        filename: filename,
                        fileUrl: file.fileUrl
                    });
                });

                // 展示文件夹和视频文件
                Object.keys(folderContentMap).forEach(folderName => {
                    const folderTitle = document.createElement('h4');
                    folderTitle.classList.add('folder-header');
                    folderTitle.textContent = folderName;

                    // 添加删除文件夹按钮
                    const deleteFolderButton = document.createElement('button');
                    deleteFolderButton.textContent = 'Delete Folder';
                    deleteFolderButton.classList.add('btn', 'btn-danger', 'btn-sm', 'ml-2');
                    deleteFolderButton.onclick = () => deleteFolder(folderName);

                    folderTitle.appendChild(deleteFolderButton);
                    fileLinksDiv.appendChild(folderTitle);

                    // 文件夹内容
                    const folderContentDiv = document.createElement('div');
                    folderContentDiv.classList.add('folder-content');

                    folderContentMap[folderName].forEach(file => {
                        const fileDiv = document.createElement('div');

                        // 创建视频链接
                        const link = document.createElement('a');
                        link.href = file.fileUrl;
                        link.textContent = file.filename;
                        link.target = '_blank'; // 在新窗口中打开

                        // 添加删除视频按钮
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete Video';
                        deleteButton.classList.add('btn', 'btn-warning', 'btn-sm', 'ml-2');
                        deleteButton.onclick = () => deleteVideo(folderName, file.filename);

                        fileDiv.appendChild(link);
                        fileDiv.appendChild(deleteButton);
                        folderContentDiv.appendChild(fileDiv);
                    });

                    // 点击文件夹名称展开/收起内容
                    folderTitle.onclick = () => {
                        folderContentDiv.style.display = folderContentDiv.style.display === 'none' ? 'block' : 'none';
                    };

                    fileLinksDiv.appendChild(folderContentDiv);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('uploadStatus').innerText = 'An error occurred while fetching file list: ' + error.message;
            });
    }

    // 删除视频文件的函数
    function deleteVideo(folderName, filename) {
        const deleteUrl = `http://13.211.82.62:3000/deleteFile/${encodeURIComponent(sessionUsername)}/${encodeURIComponent(folderName)}/${encodeURIComponent(filename)}`;

        fetch(deleteUrl, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadFileList(); // 重新加载文件列表
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file: ' + error.message);
            });
    }

    // 删除文件夹的函数
    function deleteFolder(folderName) {
        const deleteUrl = `http://13.211.82.62:3000/deleteFolder/${encodeURIComponent(sessionUsername)}/${encodeURIComponent(folderName)}`;

        fetch(deleteUrl, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadFileList(); // 重新加载文件列表
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the folder: ' + error.message);
            });
    }

    // 上传文件的函数
    document.getElementById('uploadButton').addEventListener('click', function () {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please choose a file first!');
            return;
        }

        const formData = new FormData();
        formData.append('video', file);

        document.getElementById('uploadStatus').innerText = 'Uploading...';
        const progressElement = document.getElementById('uploadProgress');
        const progressLabel = document.getElementById('progressLabel');
        progressElement.value = 0;
        progressLabel.textContent = 'Uploading...';

        // 创建 XMLHttpRequest 进行上传
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://13.211.82.62:3000/upload', true);

        // 监听上传进度
        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 50; // 上传部分占50%
                progressElement.value = percentComplete;
                progressLabel.textContent = `Uploading... ${Math.round(percentComplete)}%`;
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                document.getElementById('uploadStatus').innerText = 'Upload complete! Starting transcoding...';
                progressElement.value = 50; // 上传完成时，进度设置为50%
                progressLabel.textContent = 'Transcoding... 50%';
                startTranscodingProgress();  // 开始监控转码进度
            } else {
                document.getElementById('uploadStatus').innerText = 'Upload failed: ' + xhr.statusText;
                progressLabel.textContent = 'Error during upload';
            }
        };
        xhr.send(formData);  // 不要遗漏对 XMLHttpRequest 发送的调用
    });

        // 开始监控总的转码进度
        function startTranscodingProgress() {
            const progressElement = document.getElementById('uploadProgress');
            const progressLabel = document.getElementById('progressLabel');

            // 每秒请求一次转码进度
            const intervalId = setInterval(() => {
                fetch('http://13.211.82.62:3000/transcodingProgress', { credentials: 'include' })
                    .then(response => response.json())
                    .then(data => {
                        const transcodingProgress = data.progress * 0.5; // 转码部分占50%
                        const totalProgress = 50 + transcodingProgress; // 加上已完成的50%上传部分
                        progressElement.value = totalProgress;
                        progressLabel.textContent = `Transcoding... ${Math.round(totalProgress)}%`;

                        if (totalProgress >= 100) {
                            clearInterval(intervalId); // 停止请求
                            document.getElementById('uploadStatus').innerText = 'Transcoding complete!';
                            progressElement.value = 100;
                            progressLabel.textContent = 'Process complete!';
                            loadFileList(); // 更新文件列表
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching transcoding progress:', error);
                    });
            }, 1000);  // 每秒请求一次
        }

        // 注销用户
    document.getElementById('logoutButton').addEventListener('click', function () {
        fetch('http://13.211.82.62:3000/logout', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Logout failed');
                }
                return response.text();
            })
            .then(data => {
                alert('Logged out successfully!');
                window.location.href = '/'; // 重定向到首页
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while logging out: ' + error.message);
            });
    });

    // 页面加载后获取用户名并加载文件列表
    document.addEventListener('DOMContentLoaded', function() {
        getSessionUsername();
    });
</script>
</body>
</html>
