<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link href="/assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #uploadProgressContainer {
            width: 100%;
            margin-top: 20px;
            position: relative;
            text-align: center;
        }

        #uploadProgress {
            width: 100%;
            height: 50px;
        }

        #progressLabel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-weight: bold;
        }

        .folder-content {
            display: none;
            padding-left: 20px;
        }

        .folder-title {
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>File Upload</h2>
    <form id="uploadForm">
        <div class="mb-3">
            <label for="fileInput" class="form-label">Choose a video file</label>
            <input type="file" id="fileInput" name="video" class="form-control" accept="video/*">
        </div>
        <button type="button" class="btn btn-primary" id="uploadButton">Upload</button>
    </form>

    <!-- Upload and transcode progress bar -->
    <div id="uploadProgressContainer">
        <progress id="uploadProgress" value="0" max="100"></progress>
        <div id="progressLabel">Waiting...</div>
    </div>

    <div id="uploadStatus" class="mt-3"></div>
    <div id="fileLinks" class="mt-4"></div>

    <!-- Logout button -->
    <button type="button" class="btn btn-warning mt-3" id="logoutButton">Logout</button>
</div>

<script src="/assets/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let sessionUsername = '';

    // Fetch the current session username
    function getSessionUsername() {
        fetch('/getUserInfo', {
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                return response.json();
            })
            .then(data => {
                sessionUsername = data.username;
                loadFileList();  // Load file list
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('uploadStatus').innerText = 'An error occurred while fetching user info: ' + error.message;
            });
    }

    // Load the file list for the user
    function loadFileList() {
        fetch(`/browse/${encodeURIComponent(sessionUsername)}`, {
            credentials: 'include'
        })
            .then(response => response.json())
            .then(fileLinks => {
                const fileLinksDiv = document.getElementById('fileLinks');
                fileLinksDiv.innerHTML = ''; // Clear previous content

                Object.keys(fileLinks).forEach(folderName => {
                    // Create folder title with toggle event
                    const folderTitle = document.createElement('h4');
                    folderTitle.textContent = folderName;
                    folderTitle.classList.add('folder-title');
                    folderTitle.onclick = () => toggleFolder(folderName);

                    // Create folder content container
                    const folderContent = document.createElement('div');
                    folderContent.id = folderName;
                    folderContent.classList.add('folder-content');

                    // Add transcoded videos to each folder
                    fileLinks[folderName].forEach(file => {
                        const link = document.createElement('a');
                        link.href = file.fileUrl;
                        link.textContent = file.filename;
                        link.target = '_blank'; // Open in a new window

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete Video';
                        deleteButton.classList.add('btn', 'btn-warning', 'btn-sm', 'ml-2');
                        deleteButton.onclick = () => deleteFile(folderName, file.filename);

                        folderContent.appendChild(link);
                        folderContent.appendChild(deleteButton);
                        folderContent.appendChild(document.createElement('br'));
                    });

                    // Append folder title and content to the page
                    fileLinksDiv.appendChild(folderTitle);
                    fileLinksDiv.appendChild(folderContent);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('uploadStatus').innerText = 'An error occurred while fetching file list: ' + error.message;
            });
    }

    // Toggle folder content visibility
    function toggleFolder(folderId) {
        const folderContent = document.getElementById(folderId);
        if (folderContent.style.display === 'none' || folderContent.style.display === '') {
            folderContent.style.display = 'block';
        } else {
            folderContent.style.display = 'none';
        }
    }

    // Delete a file
    function deleteFile(folder, filename) {
        const deleteUrl = `/deleteFile/${encodeURIComponent(sessionUsername)}/${encodeURIComponent(folder)}/${encodeURIComponent(filename)}`;

        fetch(deleteUrl, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error deleting file');
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                loadFileList(); // Reload file list
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file: ' + error.message);
            });
    }

    // Logout user
    document.getElementById('logoutButton').addEventListener('click', function () {
        fetch('/logout', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Logout failed');
                }
                return response.text();
            })
            .then(data => {
                alert('Logged out successfully!');
                window.location.href = '/'; // Redirect to home
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while logging out: ' + error.message);
            });
    });

    // Load session username and file list on page load
    document.addEventListener('DOMContentLoaded', getSessionUsername);
</script>
</body>
</html>